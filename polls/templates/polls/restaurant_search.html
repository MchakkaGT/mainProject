{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Restaurant Search</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'polls/restaurantSearch.css' %}">
    <style>
        .main-content {
            display: flex;
            height: 100vh; /* Set height to viewport height */
        }
        
        .restaurant-list {
            width: 30%;
            overflow-y: auto; /* Enable vertical scrolling */
            height: 100%; /* Full height of the parent container */
        }
        
        .map-container {
            width: 50%;
            height: 100vh;
            padding-left: 10px;
        }
        
        .info-card {
            margin-bottom: 20px;
        }
        
        .search-container {
            margin: 20px 0;
        }
        
        #map {
            width: 138.5%;
            height: 100%;
        }
    </style>

</head>
<body>

    {#  NavBar   #}
    <div style="width: 100%;">
        {% include 'polls/components/navbar.html' %}
    </div>


    {#  Search Bar  #}
    <div class="search-container">
        <form method="POST" action="{% url 'polls:restaurant_search' %}">
            {% csrf_token %}
            <div class="search-bar-container">
                <label for="query" hidden>Search for restaurants</label>
                <input class="search-bar" id="query" name="query" placeholder="Search for restaurants">
                
                <button type="submit"><i class="fas fa-search"></i></button>
            </div>
            
            <div class="filters-container">
                <div class="filter">
                    <label for="rating">Minimum Rating:</label>
                    <select id="rating" name="rating">
                        <option value="" selected>Any</option>
                        <option value="1">1+</option>
                        <option value="2">2+</option>
                        <option value="3">3+</option>
                        <option value="4">4+</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="filter">
                    <label for="max_price">Max Price Level:</label>
                    <select id="max_price" name="max_price">
                        <option value="" selected>Any</option>
                        <option value="0">Free</option>
                        <option value="1">Inexpensive</option>
                        <option value="2">Moderate</option>
                        <option value="3">Expensive</option>
                        <option value="4">Very Expensive</option>
                    </select>
                </div>
                <div class="filter">
                    <label for="distance">Max Distance (km):</label>
                    <input type="number" id="distance" name="distance" placeholder="e.g., 5">
                </div>
            </div>
            
        </form>
    </div>

    {#  Restaurant Cards  #}
    <div class="main-content">
        <div class="card-grid restaurant-list">
            {% if details %}
                {% for detail in details %}
                    <div class="info-card">
                        {% include 'polls/components/infoCard.html' with detail=detail%}
                    </div>
                {% endfor %}
            {% else %}
                <p>Search for restaurants by typing their name, cuisine type, or street name.</p>
            {% endif %}
        </div>

        <div class="map-container">
            <div id="map" style="height: 100vh; width: 100%;"></div>
        </div>
    </div>

<script>
        let map;
        let infoWindow;

        async function initMap() {
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 34.1966224, lng: -84.2235670 }, // Default center coordinates (can be any starting point)
                zoom: 15,
            });

            const restaurantData = {{ mapDetails|safe }};

            const markers = [];

            // Add markers for restaurants
            restaurantData.forEach(restaurant => {
                const marker = new google.maps.Marker({
                    position: { lat: restaurant.lat, lng: restaurant.lng },
                    map: map,
                    title: restaurant.name
                });

                markers.push(marker);

                const infoWindow = new google.maps.InfoWindow({
                    content: `<div>
                                <h3>${restaurant.name}</h3>
                                <p>${restaurant.address}</p>
                                <p>Rating: ${restaurant.rating}</p>
                              </div>`
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            });

            // Function to add user's current position marker
            function addUserMarker(userPos) {
                if (userPos) {
                    const userMarker = new google.maps.Marker({
                        position: userPos,
                        map: map,
                        title: "Your Location",
                        icon: {
                            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" // NOT LOADING WORK IN CLASS
                        }
                    });

                    markers.push(userMarker);
                }
            }

            getUserPos();

            const locationButton = document.createElement("button");
            locationButton.textContent = "Pan to Current Location";
            locationButton.classList.add("custom-map-control-button");
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
            locationButton.addEventListener("click", () => {
                getUserPos();
            });

            // Function to fit map to contain all markers
            function fitMapToBounds() {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                map.fitBounds(bounds);
            }

            // Fit map to show all markers
            fitMapToBounds();
        }

        function getUserPos() {
            let userPos;
            if (infoWindow) {
                infoWindow.close();
            }
            infoWindow = new google.maps.InfoWindow();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userPos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        infoWindow.setPosition(userPos);
                        infoWindow.open(map);
                        map.setCenter(userPos);

                        // Add user's marker
                        addUserMarker(userPos);

                        // Fit map to show all markers including user's position
                        fitMapToBounds();
                    },
                    () => {
                        handleLocationError(true, infoWindow, map.getCenter());
                    },
                );
            } else {
                handleLocationError(false, infoWindow, map.getCenter());
            }
            return userPos;
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(
                browserHasGeolocation
                    ? "Error: The Geolocation service failed."
                    : "Error: Your browser doesn't support geolocation.",
            );
            infoWindow.open(map);
        }

        initMap();
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABdQf3ttPoUcYqIFNhRzgL3V-zOBNbUx0&callback=initMap"></script>





</body>
</html>
